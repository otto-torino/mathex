<!DOCTYPE html5>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mathex recovery tests</title>
    <script src="../res-otto/js/modernizr.js"></script>
    <script src="../res-otto/js/mootools-core-yc.js"></script>
    <script src="../res-otto/js/mootools-more-yc.js"></script>
    <script src="../res-otto/js/mathex.js"></script>
    <script type="text/javascript"
      src="../res-otto/js/MathJax.js?config=custom">
    </script>
    <script src="ajsut.js"></script>
    <link rel="stylesheet" type="text/css" href="../res-otto/css/style.css" />
    <link rel="stylesheet" type="text/css" href="ajsut.css" />
  </head>
  <body class="aritmetica">
    <header>
      <h1 class="left">Mathex recovery tests</h1>
      <p class="right" id="widgets"></p>
      <div class="clear"></div>
    </header>
    <h2>Autoverifica</h2>
    <div id="container"></div>

    <script>

      alert('sit down and keep calm');

      mathex.config.font_ctrl = true;

      var recovery = new mathex.Recovery([
        {
          title: "First recovery item",
          tpl: '<img class="toggle" src="../html/img/img.png" width="200" />' +
               '<p>normal: [[48]]' +
               '<p>with math: [[{% 54^5 %}]]' +
               '<ol>' +
                 '<li>other: [[{% 54^5 %}]]</li>' +
               '</ol>'
        },
        {
          title: "Second item",
          tpl: "<p>Template without hidden boxes {% 3x -5 = x + 7 %}</p><p>Meow</p>"
        }
      ])

      var router = new mathex.RecoveryRouter(recovery);
      router.start();

      // checking index
      ajsut.test('Checking index', function() {
        ajsut.assert($$('#r_container ul li').length == 2, 'The index has 2 items');
      })

      // clicking 2 item
      ajsut.test('Clicking the second item', function() {
        ajsut.pause();
        setTimeout(function() {
          $$('#r_container ul li')[1].fireEvent('click', {});
          ajsut.assert($$('#r_container h2')[0].get('text') == 'Second item', 'Second item rendered');
          ajsut.resume();
        }, 2000);
      })

      // clicking prev button
      ajsut.test('Clicking prev button', function() {
        ajsut.pause();
        setTimeout(function() {
          $$('#r_nav span')[0].fireEvent('click', {});
          ajsut.assert($$('#r_container h2')[0].get('text') == 'First recovery item', 'First item rendered');
          var img = $$('img.toggle')[0];
          ajsut.assert(/.*\/img.png$/.test(img.src), 'original image charged');
          var evObj = document.createEvent('MouseEvents');
          evObj.initMouseEvent( 'click', true, true, window, 1, 1, 1, 7, 220, false, false, true, false, 0, null );
          img.dispatchEvent(evObj);
          ajsut.assert(/.*\/img_toggle.png$/.test(img.src), 'image was toggled');
          ajsut.assert($$('.recovery-hidden').length == 3, 'Three hidden boxes');
          $$('.recovery-hidden')[0].fireEvent('click', {});
          ajsut.assert($$('.recovery-hidden').length == 2, 'Two hidden boxes after clicking the first');
          ajsut.resume();
        }, 2000);
      })

      // back to index
      ajsut.test('Back to index', function() {
        ajsut.pause();
        setTimeout(function() {
          $$('#r_nav span')[0].fireEvent('click', {});
          ajsut.assert($$('#r_container ul li').length == 2, 'The index has 2 items');

          var tests = $$('#results li li').length;
          var passed = $$('#results li li.passed').length;
          var failed = $$('#results li li.failed').length;

          var result = tests + ' tests executed.\n' + passed + ' passed.\n' + failed + ' failed.';
          if(failed) result += '\nThat\'s bad.';
          else result += '\nThat\'s good dude.';
          alert(result);

          ajsut.resume();
        }, 2000);
      })

    </script>
  </body>
</html>
